{"version":"NotebookV1","origId":2967298026817397,"name":"08_drift_detection","language":"python","commands":[{"version":"CommandV1","origId":6761707956393627,"guid":"a09c0439-c008-49a5-aff6-ed3c262ea801","subtype":"command","commandType":"auto","position":1.0,"command":"%pip install --quiet databricks-sdk mlflow-skinny --upgrade dbldatagen\n\n\n%restart_python","commandVersion":1,"state":"input","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"latestAssumeRoleInfo":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"tableResultSettingsMap":{},"nuid":"69ed4af5-2588-4e6e-b017-5d327e288fca"},{"version":"CommandV1","origId":6761707956393629,"guid":"9f78d182-fe1a-4f9c-b76e-3b28cac90745","subtype":"command","commandType":"auto","position":0.5,"command":"%md\nDrift detection\nIn this step, we will define drift detection rules to run periodically on the inference data.\n\nDrift detection refers to the process of identifying changes in the statistical properties of input data, which can lead to a decline in model performance over time. This is crucial for maintaining the accuracy and reliability of models in dynamic environments, as it allows for timely interventions such as model retraining or adaptation to new data distributions\n\nIn order to simulate some data drifts, we will use dbldatagen library, a Databricks Labs project which is a Python library for generating synthetic data using Spark.\n\nWe will simulate label drift using the data generator package. Label drift occurs when the distribution of the ground truth labels changes over time, which can happen due to shifts in labeling criteria or the introduction of labeling errors. We will create both label and prediction drifts.\n\n","commandVersion":1,"state":"input","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"latestAssumeRoleInfo":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"tableResultSettingsMap":{},"nuid":"dd9d3abd-b1c6-4fdb-80b3-96b136d9bb6c"},{"version":"CommandV1","origId":6761707956393630,"guid":"5268cc89-8016-4263-9963-b3e4ada545fe","subtype":"command","commandType":"auto","position":2.0,"command":"dbutils.widgets.dropdown(\"perf_metric\", \"f1_score.macro\", [\"accuracy_score\", \"precision.weighted\", \"recall.weighted\", \"f1_score.macro\"])\ndbutils.widgets.dropdown(\"drift_metric\", \"js_distance\", [\"chi_squared_test.statistic\", \"chi_squared_test.pvalue\", \"tv_distance\", \"l_infinity_distance\", \"js_distance\"])\ndbutils.widgets.text(\"model_id\", \"*\", \"Model Id\")","commandVersion":1,"state":"input","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"latestAssumeRoleInfo":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"tableResultSettingsMap":{},"nuid":"8bcc38d8-ed57-4fd4-a105-50e97398b5b8"},{"version":"CommandV1","origId":6761707956393631,"guid":"4813ac11-2279-4b87-8b47-621c0074eb8f","subtype":"command","commandType":"auto","position":3.0,"command":"import time\nfrom databricks.sdk import WorkspaceClient\nfrom databricks.sdk.service.catalog import MonitorInfoStatus, MonitorRefreshInfoState\n\n\nw = WorkspaceClient()\nrefresh_info = w.quality_monitors.run_refresh(table_name=f\"{catalog}.{db}.advanced_churn_inference_table\")\n\nwhile refresh_info.state in (MonitorRefreshInfoState.PENDING, MonitorRefreshInfoState.RUNNING):\n  refresh_info = w.quality_monitors.get_refresh(table_name=f\"{catalog}.{db}.advanced_churn_inference_table\", refresh_id=refresh_info.refresh_id)\n  time.sleep(180)","commandVersion":1,"state":"input","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"latestAssumeRoleInfo":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"tableResultSettingsMap":{},"nuid":"46e4f249-5a28-4b8c-8b43-e6528acd40b4"},{"version":"CommandV1","origId":6761707956393632,"guid":"e26d6bfc-e490-4236-a82e-89d3ea64266b","subtype":"command","commandType":"auto","position":4.0,"command":"monitor_info = w.quality_monitors.get(table_name=f\"{catalog}.{db}.advanced_churn_inference_table\")\ndrift_table_name = monitor_info.drift_metrics_table_name\nprofile_table_name = monitor_info.profile_metrics_table_name","commandVersion":1,"state":"input","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"latestAssumeRoleInfo":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"tableResultSettingsMap":{},"nuid":"81b024bc-be74-417e-9904-e54398fc9f76"},{"version":"CommandV1","origId":6761707956393633,"guid":"d0b4c0d2-f5ea-4cee-8665-0c9f5044cadc","subtype":"command","commandType":"auto","position":5.0,"command":"metric = dbutils.widgets.get(\"perf_metric\")\ndrift = dbutils.widgets.get(\"drift_metric\")\nmodel_id = dbutils.widgets.get(\"model_id\")","commandVersion":1,"state":"input","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"latestAssumeRoleInfo":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"tableResultSettingsMap":{},"nuid":"4d052c78-afd5-4cc4-89fb-8bdecf3efa40"},{"version":"CommandV1","origId":6761707956393634,"guid":"39db47a2-3d6c-4475-a0b3-7518344bcbe8","subtype":"command","commandType":"auto","position":6.0,"command":"performance_metrics_df = spark.sql(f\"\"\"\nSELECT\n  window.start as time,\n  {metric} AS performance_metric,\n  expected_loss,\n  Model_Version AS `Model Id`\nFROM {profile_table_name}\nWHERE\n  window.start >= \"2025-06-28\"\n\tAND log_type = \"INPUT\"\n  AND column_name = \":table\"\n  AND slice_key is null\n  AND slice_value is null\n  AND Model_Version = '{model_id}'\nORDER BY\n  window.start\n\"\"\"\n)\ndisplay(performance_metrics_df)","commandVersion":1,"state":"input","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"latestAssumeRoleInfo":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"tableResultSettingsMap":{},"nuid":"b59c3f5f-ae94-4231-b467-2df639d807c9"},{"version":"CommandV1","origId":6761707956393635,"guid":"840d488c-293f-43f3-9afb-e21bf4bc5d9e","subtype":"command","commandType":"auto","position":7.0,"command":"drift_metrics_df = spark.sql(f\"\"\"\n  SELECT\n  window.start AS time,\n  column_name,\n  {drift} AS drift_metric,\n  Model_Version AS `Model Id`\nFROM {drift_table_name}\nWHERE\n  column_name IN ('prediction', 'churn')\n  AND window.start >= \"2025-06-30\"\n  AND slice_key is null\n  AND slice_value is null\n  AND Model_Version = '{model_id}'\n  AND drift_type = \"CONSECUTIVE\"\nORDER BY\n  window.start\n\"\"\"\n)\ndisplay(drift_metrics_df )","commandVersion":1,"state":"input","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"latestAssumeRoleInfo":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"tableResultSettingsMap":{},"nuid":"c090066e-8642-49bb-8a30-d7b3a365f10a"},{"version":"CommandV1","origId":6761707956393636,"guid":"737d1f70-1226-4006-8aaf-6451655e3974","subtype":"command","commandType":"auto","position":8.0,"command":"from pyspark.sql.functions import first\n\n\n# If no drift on the label or prediction, we skip it\nif not drift_metrics_df.isEmpty():\n    unstacked_drift_metrics_df = (\n        drift_metrics_df.groupBy(\"time\", \"`Model Id`\")\n        .pivot(\"column_name\")\n        .agg(first(\"drift_metric\"))\n        .orderBy(\"time\")\n    )\n    display(unstacked_drift_metrics_df)","commandVersion":1,"state":"input","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"latestAssumeRoleInfo":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"tableResultSettingsMap":{},"nuid":"833581b7-30a2-4688-b913-c24542b4b3a7"},{"version":"CommandV1","origId":6761707956393637,"guid":"8a6396fb-96ca-42e2-92f7-4496f3e12ffe","subtype":"command","commandType":"auto","position":9.0,"command":"all_metrics_df = performance_metrics_df\nif not drift_metrics_df.isEmpty():\n    all_metrics_df = performance_metrics_df.join(\n        unstacked_drift_metrics_df, on=[\"time\", \"Model Id\"], how=\"inner\"\n    )\n\ndisplay(all_metrics_df)","commandVersion":1,"state":"input","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"latestAssumeRoleInfo":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"tableResultSettingsMap":{},"nuid":"b3542a02-dc37-4224-885b-fed20c46dc7c"},{"version":"CommandV1","origId":6761707956393638,"guid":"450d4b0e-ea4d-4cb1-951f-6041169f7602","subtype":"command","commandType":"auto","position":10.0,"command":"from pyspark.sql.functions import col, abs\n\n\nperformance_violation_count = all_metrics_df.where(\n    (col(\"performance_metric\") < 0.5) & (abs(col(\"expected_loss\")) > 30)\n).count()\n\ndrift_violation_count = 0\nif not drift_metrics_df.isEmpty():\n    drift_violation_count = all_metrics_df.where(\n        (col(\"churn\") > 0.19) & (col(\"prediction\") > 0.19)\n    ).count()\n\nall_violations_count = drift_violation_count + performance_violation_count","commandVersion":1,"state":"input","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"latestAssumeRoleInfo":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"tableResultSettingsMap":{},"nuid":"0f112f25-665e-45ea-8dfc-6d3579e6078e"},{"version":"CommandV1","origId":6761707956393639,"guid":"b9363a80-790e-4a1a-8ec4-3c56ecec851c","subtype":"command","commandType":"auto","position":11.0,"command":"print(f\"Total number of joint violations: {all_violations_count}\")","commandVersion":1,"state":"input","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"latestAssumeRoleInfo":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"tableResultSettingsMap":{},"nuid":"20a4a94f-ccf5-4d2a-850d-f69e130d1ad5"},{"version":"CommandV1","origId":6761707956393640,"guid":"c55331c6-d052-454c-8146-6b370953f416","subtype":"command","commandType":"auto","position":12.0,"command":"dbutils.jobs.taskValues.set(key = 'all_violations_count', value = all_violations_count)","commandVersion":1,"state":"input","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"latestAssumeRoleInfo":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"tableResultSettingsMap":{},"nuid":"438b12ca-1e8a-431e-a0e7-165290948f72"}],"dashboards":[],"guid":"3b251e8a-2d6b-4941-9f6e-59540635e74e","globalVars":{},"iPythonMetadata":null,"inputWidgets":{},"notebookMetadata":{"pythonIndentUnit":4},"reposExportFormat":"JUPYTER","environmentMetadata":{"client":"4","base_environment":""},"computePreferences":null,"inputWidgetPreferences":null}